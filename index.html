<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Türkiye Nöbetçi Eczaneler</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #D32F2F;
            --secondary: #FFCDD2;
            --dark: #2c3e50;
            --light: #f8f9fa;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Poppins', sans-serif;
            background: var(--light);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- SAYFA YÖNETİMİ --- */
        .page {
            display: none; width: 100%; height: 100%;
            flex-direction: column; animation: fadeIn 0.3s ease-in-out;
        }
        .page.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- 1. ANA MENÜ (HOME) --- */
        #home-page {
            display: none; flex-direction: column; align-items: center;
            background: linear-gradient(135deg, #D32F2F 0%, #b71c1c 100%);
            color: white; text-align: center; height: 100%;
        }
        #home-page.active { display: flex; }

        .home-content {
            flex: 1; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            width: 100%; padding: 20px; box-sizing: border-box;
        }
        
        .logo-area { margin-bottom: 30px; }
        .logo-area i { font-size: 70px; margin-bottom: 10px; text-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .logo-area h1 { margin: 0; font-size: 26px; font-weight: 700; letter-spacing: 0.5px; }
        .logo-area p { opacity: 0.9; font-size: 14px; font-weight: 300; }

        .main-menu-btn {
            background: white; color: var(--primary); border: none;
            width: 100%; max-width: 350px; padding: 20px;
            margin: 10px 0; border-radius: 18px; font-size: 16px; font-weight: 700;
            cursor: pointer; box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            display: flex; align-items: center; transition: transform 0.2s;
        }
        .main-menu-btn i { font-size: 24px; margin-right: 15px; width: 30px; text-align: center; }
        .main-menu-btn:active { transform: scale(0.96); }

        /* --- İMZA ALANI --- */
        .app-footer {
            padding: 25px; width: 100%; text-align: center;
            background: rgba(0, 0, 0, 0.1); backdrop-filter: blur(5px);
        }
        .footer-text {
            font-size: 18px; color: rgba(255,255,255, 1);
            font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3); display: block; margin-bottom: 5px;
        }
        .footer-sub { font-size: 12px; color: rgba(255,255,255, 0.8); font-weight: 300; }

        /* --- HEADER --- */
        .header {
            background: white; padding: 15px; display: flex; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 100;
        }
        .back-btn {
            background: none; border: none; font-size: 22px; color: var(--dark);
            cursor: pointer; padding: 5px;
        }
        .header-title { flex: 1; text-align: center; font-weight: 700; color: var(--dark); font-size: 16px; }

        /* --- FORM ALANLARI --- */
        .form-container { padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .form-wrapper { width: 100%; max-width: 500px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        select {
            width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 12px;
            font-size: 16px; background: white; outline: none;
        }
        .btn-primary {
            background: var(--primary); color: white; border: none; width: 100%; padding: 15px;
            border-radius: 12px; font-size: 16px; font-weight: bold; margin-top: 10px; cursor: pointer;
        }

        /* --- HARİTA --- */
        #map-container { flex: 1; width: 100%; position: relative; }
        #map { width: 100%; height: 100%; }
        .map-overlay-controls {
            position: absolute; top: 10px; left: 10px; right: 10px;
            z-index: 999; display: flex; gap: 10px; justify-content: center;
        }
        .district-badge {
            background: white; padding: 10px 20px; border-radius: 30px; font-weight: 600;
            color: var(--dark); box-shadow: 0 2px 10px rgba(0,0,0,0.2); text-align: center; min-width: 150px;
        }
        .gps-btn {
            width: 45px; height: 45px; border-radius: 50%; background: var(--primary);
            color: white; border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.2); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }

        /* --- LİSTE --- */
        #list-container { flex: 1; overflow-y: auto; padding: 15px; background: #f4f4f4; }
        .pharmacy-card {
            background: white; padding: 20px; border-radius: 15px; margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03); border-left: 5px solid var(--primary);
            position: relative; width: 100%; max-width: 600px; margin-left: auto; margin-right: auto; box-sizing: border-box;
        }
        .ph-name { font-size: 17px; font-weight: 700; color: var(--dark); }
        .ph-dist {
            position: absolute; top: 20px; right: 20px; background: var(--secondary);
            color: var(--primary); font-size: 11px; padding: 4px 10px; border-radius: 20px; font-weight: bold;
        }
        .ph-address { font-size: 13px; color: #666; margin: 10px 0 15px 0; line-height: 1.4; }
        .ph-actions { display: flex; gap: 10px; }
        .action-btn {
            flex: 1; padding: 10px; border-radius: 8px; text-align: center;
            text-decoration: none; font-size: 13px; font-weight: 600;
        }
        .call-btn { background: #E3F2FD; color: #1565C0; }
        .dir-btn { background: #FFEBEE; color: #C62828; }

        /* LOADING */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 2000;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(33, 150, 243, 0); }
        100% { box-shadow: 0 0 0 0 rgba(33, 150, 243, 0); }
    }

</style>
</head>
<body>

<div id="loading-overlay">
    <i class="fas fa-spinner fa-spin fa-3x" style="color: var(--primary);"></i>
    <p id="loading-text" style="margin-top: 15px; font-weight: bold; color: #333;">İşlem Yapılıyor...</p>
    <small id="loading-sub" style="color:#666; margin-top:5px;"></small>
</div>

<div id="home-page" class="page active">
    
    <div class="home-content">
        <div class="logo-area">
            <i class="fas fa-briefcase-medical"></i>
            <h1>Nöbetçi Eczanem</h1>
            <p>Tüm Türkiye / 81 İl</p>
        </div>

        <button class="main-menu-btn" onclick="handleMenuClick('auto-gps')">
            <i class="fas fa-crosshairs" style="color: #e57373;"></i>
            <div>
                <div style="text-align:left">Konuma Göre Bul</div>
                <div style="font-size:12px; font-weight:400; text-align:left; color:#666">Otomatik konum algıla</div>
            </div>
        </button>

        <button class="main-menu-btn" onclick="handleMenuClick('list')">
            <i class="fas fa-list-ul" style="color: #64b5f6;"></i>
            <div>
                <div style="text-align:left">Eczane Listesi</div>
                <div style="font-size:12px; font-weight:400; text-align:left; color:#666">İl/İlçe seçerek listele</div>
            </div>
        </button>

        <button class="main-menu-btn" onclick="handleMenuClick('manual')">
            <i class="fas fa-search-location" style="color: #81c784;"></i>
            <div>
                <div style="text-align:left">Adresini Gir</div>
                <div style="font-size:12px; font-weight:400; text-align:left; color:#666">Manuel bölge seçimi</div>
            </div>
        </button>
    </div>

    <div class="app-footer">
        <span class="footer-text">© MUSTAFA SEVİNDİK</span>
        <span class="footer-sub">Designed & Developed by Mustafa Sevindik</span>
    </div>

</div>

<div id="selection-page" class="page">
    <div class="header">
        <button class="back-btn" onclick="goHome()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">Bölge Seçimi</span>
    </div>
    <div class="form-container">
        <div class="form-wrapper">
            <div class="form-group">
                <label>Hangi İldesiniz?</label>
                <select id="city-select" onchange="onCityChanged()">
                    <option value="" disabled selected>İl Seçiniz...</option>
                </select>
            </div>
            <div class="form-group" id="district-group" style="display:none; opacity: 0.5;">
                <label>İlçe (Opsiyonel)</label>
                <select id="district-select">
                    <option value="all">Tüm İlçeler</option>
                </select>
            </div>
            <button class="btn-primary" onclick="confirmSelection()">Sonuçları Göster</button>
        </div>
    </div>
</div>

<div id="map-page" class="page">
    <div class="header">
        <button class="back-btn" onclick="goHome()"><i class="fas fa-arrow-left"></i></button>
        <div class="header-title">
            <span id="map-city-label">Harita</span>
        </div>
    </div>
    <div id="map-container">
        <div class="map-overlay-controls">
            <div class="district-badge" id="map-district-label">Yakın Eczaneler</div>
            <button class="gps-btn" onclick="locateUser(true)"><i class="fas fa-crosshairs"></i></button>
        </div>
        <div id="map"></div>
    </div>
</div>

<div id="list-page" class="page">
    <div class="header">
        <button class="back-btn" onclick="goHome()"><i class="fas fa-arrow-left"></i></button>
        <div class="header-title">
            <span id="list-city-label">Liste</span>
        </div>
    </div>
    <div id="list-container"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const turkeyCities = [
        "Adana", "Adıyaman", "Afyonkarahisar", "Ağrı", "Amasya", "Ankara", "Antalya", "Artvin", "Aydın", "Balıkesir", 
        "Bilecik", "Bingöl", "Bitlis", "Bolu", "Burdur", "Bursa", "Çanakkale", "Çankırı", "Çorum", "Denizli", 
        "Diyarbakır", "Edirne", "Elazığ", "Erzincan", "Erzurum", "Eskişehir", "Gaziantep", "Giresun", "Gümüşhane", 
        "Hakkari", "Hatay", "Isparta", "Mersin", "İstanbul", "İzmir", "Kars", "Kastamonu", "Kayseri", "Kırklareli", 
        "Kırşehir", "Kocaeli", "Konya", "Kütahya", "Malatya", "Manisa", "Kahramanmaraş", "Mardin", "Muğla", "Muş", 
        "Nevşehir", "Niğde", "Ordu", "Rize", "Sakarya", "Samsun", "Siirt", "Sinop", "Sivas", "Tekirdağ", "Tokat", 
        "Trabzon", "Tunceli", "Şanlıurfa", "Uşak", "Van", "Yozgat", "Zonguldak", "Aksaray", "Bayburt", "Karaman", 
        "Kırıkkale", "Batman", "Şırnak", "Bartın", "Ardahan", "Iğdır", "Yalova", "Karabük", "Kilis", "Osmaniye", "Düzce"
    ];

    let appState = {
        selectedCity: null,
        selectedDistrict: 'all',
        pharmacies: [],
        targetView: 'map',
        userLocation: null
    };
    
    let map, markersLayer, userMarker;

    window.onload = () => {
        populateCities();
        initMap();
    };

    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
    }

    function goHome() {
        showPage('home-page');
    }

    async function handleMenuClick(type) {
        if (type === 'auto-gps') {
            await autoDetectLocationAndCity();
        } 
        else if (type === 'manual') {
            appState.targetView = 'map'; 
            showPage('selection-page');
        } 
        else {
            appState.targetView = type;
            if (!appState.selectedCity) {
                showPage('selection-page');
            } else {
                openTargetView();
            }
        }
    }

    // --- OTOMATİK KONUM VE ŞEHİR ALGILAMA ---
    function autoDetectLocationAndCity() {
        const loader = document.getElementById('loading-overlay');
        const loadText = document.getElementById('loading-text');
        const loadSub = document.getElementById('loading-sub');
        
        loader.style.display = 'flex';
        loadText.innerText = "Konumunuz Alınıyor...";
        loadSub.innerText = "Lütfen izin verin";

        if (!navigator.geolocation) {
            alert("Tarayıcınız konum servisini desteklemiyor.");
            loader.style.display = 'none';
            return;
        }

        navigator.geolocation.getCurrentPosition(async (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            appState.userLocation = { lat, lng };

            loadText.innerText = "Şehir Bulunuyor...";
            
            try {
                // Nominatim ile Reverse Geocode
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await response.json();
                
                let detectedCity = data.address.province || data.address.city || data.address.state;
                if(detectedCity) {
                    detectedCity = normalizeCityName(detectedCity);
                }

                if (detectedCity && turkeyCities.includes(detectedCity)) {
                    loadText.innerText = `${detectedCity} Eczaneleri Yükleniyor...`;
                    appState.selectedCity = detectedCity;
                    appState.selectedDistrict = 'all';
                    
                    await fetchPharmacies(detectedCity);
                    
                    appState.targetView = 'map';
                    openTargetView();
                    
                    setTimeout(() => { locateUser(true); }, 500);
                } else {
                    alert("Şehir otomatik algılanamadı. Lütfen listeden seçin.");
                    showPage('selection-page');
                }

            } catch (error) {
                console.error(error);
                alert("Konum servisine bağlanılamadı. Manuel seçim yapınız.");
                showPage('selection-page');
            } finally {
                loader.style.display = 'none';
            }

        }, (err) => {
            loader.style.display = 'none';
            alert("Konum izni verilmedi. Ayarlardan açabilir veya manuel seçebilirsiniz.");
        }, { enableHighAccuracy: true, timeout: 10000 });
    }

    function normalizeCityName(rawName) {
        let name = rawName.replace(' ili', '').replace(' Valiliği', '').replace(' Belediyesi', '').trim();
        return turkeyCities.find(c => c.toLowerCase() === name.toLowerCase()) || name;
    }

    function populateCities() {
        const select = document.getElementById('city-select');
        turkeyCities.sort().forEach(city => {
            let option = document.createElement('option');
            option.value = city; option.text = city;
            select.appendChild(option);
        });
    }

    async function onCityChanged() {
        const city = document.getElementById('city-select').value;
        appState.selectedCity = city;
        const loader = document.getElementById('loading-overlay');
        document.getElementById('loading-text').innerText = "Veriler Çekiliyor...";
        loader.style.display = 'flex';
        
        try {
            await fetchPharmacies(city);
            populateDistricts();
            document.getElementById('district-group').style.display = 'block';
            document.getElementById('district-group').style.opacity = '1';
        } catch (e) {
            alert("Veri çekilirken hata oluştu.");
        } finally {
            loader.style.display = 'none';
        }
    }

    function populateDistricts() {
        const districtSelect = document.getElementById('district-select');
        districtSelect.innerHTML = '<option value="all">Tüm İlçeler</option>';
        const districts = [...new Set(appState.pharmacies.map(p => p.dist))].sort();
        districts.forEach(dist => {
            let option = document.createElement('option');
            option.value = dist; option.text = dist;
            districtSelect.appendChild(option);
        });
    }

    function confirmSelection() {
        if (!appState.selectedCity) { alert("Lütfen önce bir İl seçiniz."); return; }
        appState.selectedDistrict = document.getElementById('district-select').value;
        openTargetView();
    }

    function openTargetView() {
        const filteredData = filterData();
        const label = appState.selectedCity + (appState.selectedDistrict !== 'all' ? ' / ' + appState.selectedDistrict : '');
        document.getElementById('map-city-label').innerText = label;
        document.getElementById('list-city-label').innerText = label;
        document.getElementById('map-district-label').innerText = appState.selectedDistrict === 'all' ? appState.selectedCity + " Geneli" : appState.selectedDistrict;

        if (appState.targetView === 'map') {
            showPage('map-page');
            setTimeout(() => { map.invalidateSize(); renderMap(filteredData); }, 200);
        } else {
            showPage('list-page'); renderList(filteredData);
        }
    }

    function filterData() {
        if (appState.selectedDistrict === 'all') return appState.pharmacies;
        return appState.pharmacies.filter(p => p.dist === appState.selectedDistrict);
    }

    async function fetchPharmacies(city) {
        const response = await fetch(`/api/dutyPharmacy?il=${encodeURIComponent(city)}`, {
            headers: { "content-type": "application/json" }
        });
        const result = await response.json();
        if (result.success) appState.pharmacies = result.result;
        else throw new Error("API Hatası");
    }
    function renderList(data) {
        const container = document.getElementById('list-container');
        container.innerHTML = "";
        if(data.length === 0) {
            container.innerHTML = "<p style='text-align:center; padding:20px;'>Kayıt bulunamadı.</p>"; return;
        }
        data.forEach(item => {
            const mapLink = `https://www.google.com/maps/dir/?api=1&destination=${item.loc}`;
            
            container.innerHTML += `
                <div class="pharmacy-card">
                    <span class="ph-dist">${item.dist}</span>
                    <div class="ph-name">${item.name}</div>
                    <div class="ph-address"><i class="fas fa-map-pin"></i> ${item.address}</div>
                    <div class="ph-actions">
                        <a href="tel:${item.phone}" class="action-btn call-btn"><i class="fas fa-phone"></i> Ara</a>
                        <a href="${mapLink}" target="_blank" class="action-btn dir-btn"><i class="fas fa-directions"></i> Yol Tarifi</a>
                    </div>
                </div>`;
        });
    }
    function initMap() {
        map = L.map('map').setView([39.9207, 32.8541], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
        markersLayer = L.layerGroup().addTo(map);
    }

    function renderMap(data) {
        markersLayer.clearLayers();
        if (data.length === 0) return;
        let bounds = L.latLngBounds();
        data.forEach(item => {
            let coords = item.loc.split(',');
            let lat = parseFloat(coords[0]);
            let lng = parseFloat(coords[1]);
            const mapLink = `https://www.google.com/maps/dir/?api=1&destination=${item.loc}`;

            let marker = L.marker([lat, lng])
                .bindPopup(`<b>${item.name}</b><br>${item.dist}<br><a href="${mapLink}" target="_blank" style="color:red; font-weight:bold;">Yol Tarifi Al</a>`);
            markersLayer.addLayer(marker);
            bounds.extend([lat, lng]);
        });
        
        if(appState.userLocation) {
            addBlueDot(appState.userLocation.lat, appState.userLocation.lng);
            bounds.extend([appState.userLocation.lat, appState.userLocation.lng]);
        }
        map.fitBounds(bounds, { padding: [50, 50] });
    }

    function addBlueDot(lat, lng) {
        if (userMarker) map.removeLayer(userMarker);
        userMarker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'user-dot',
                html: '<div style="width:18px;height:18px;background:#2196F3;border:3px solid white;border-radius:50%;box-shadow:0 0 5px black; animation: pulse 2s infinite;"></div>'
            })
        }).addTo(map).bindPopup("Siz").openPopup();
    }

    function locateUser(forceZoom = false) {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                let lat = pos.coords.latitude;
                let lng = pos.coords.longitude;
                appState.userLocation = { lat, lng };
                addBlueDot(lat, lng);
                if(forceZoom) map.setView([lat, lng], 14);
            }, () => alert("Konum izni verilmedi."));
        }
    }
</script>
</body>
</html>